# Unbound internet.nl branch

Unbound branch containing the internetnl module, used for connection test and
interactive mail test on internet.nl.

Three delegations from the `<base-domain>` (default base-domain = internet.nl)
zone are required for this module:
  - `<mail-lab>`, default = "mail-test", IPv6 and IPv4 glue required
  - `<signed-lab>`, default = "test-ns-signed", IPv6 and IPv4 glue required
  - `<signed-lab6>`, default = "test-ns6-signed", must only have IPv6 glue

## Interactive mail test query handling
Email for the interactive mail test will be send from `<testid>`.`<mail-lab>`.`<base-domain>`.

## Testing validation anti spoofing standards
Receivers of these email messages should now query for DKIM, DMARC and SPF
records. Queries that will be logged, and there corresponding redis keys:
  - TXT `<testid>`.`<mail-lab>`.`<base-domain>` -->`interactivemailtest:spf:<testid>`
  - TXT \_dmarc.`<testid>`.`<mail-lab>`.`<base-domain>` --> `interactivemailtest:dmarc:<testid>`
  - TXT selector.\_domainkey.`<testid>`.`<mail-lab>`.`<base-domain>` --> `interactivemailtest:dkim:<testid>`

## Testing DANE validation
If the receiver of the email message will reply the mx record will be requested
and generated by the internetnl Unbound module:
 - MX `<testid>`.`<mail-lab>`.`<base-domain>` --> `<testid>`.`<signed-lab>`.`<base-domain>`,
   the default signed-lab is "test-ns-signed".

If the user's MTA will validate DANE, a query will be send and logged in redis:
  - TLSA \_25.\_tcp.`<testid>`.`<signed-lab>`.`<base-domain>` --> `interactivemailtest:dane:<testid>`.

## Connection test query handling
For queries for the connection test the address of the resolver contacting us
will be logged. Connection test queries are a subdomain of `<client-log-lab>`.`<signed-lab>`.`<base-domain>`. The default client-log-lab = conn.

Addresses will be logged in a redis set, with as key "ns\_`<qname>`"

## Installation
 - Make sure that `swig` >= 3.0 is installed on your system

   `apt install swig3.0`
 - Change #defines on top of internetnl/internetnl.c to match test environment
 - Patch unbound with internet.nl's patch

   `patch -p0 -i /path/to/unbound_1.8.0_patch_unsupported_ds.diff`
 - `./configure --prefix=$HOME/usr/local --enable-internetnl --with-pyunbound --with-libevent --with-libhiredis`
 - `make install`

## Configuration
Example zonefiles are available in the `internetnl` directory. Don't forget to update the
DKIM, SPF and DMARC values to match the sending MTA, and the IP addresses.

```
server:
	local-zone: "." refuse
	local-zone: "<mail-lab>.<base-domain>" transparent
	local-zone: "<signed-lab>.<base-domain>" transparent
	local-zone: "<signed-lab6>.<base-domain>" transparent
	interface: 0.0.0.0
	access-control: 0.0.0.0/0 allow_snoop
	module-config: "internetnl iterator"

auth-zone:
	name: "<mail-lab>.<base-domain>"
	zonefile: "<mail-lab>.<base-domain>.zone"
	fallback-enabled: no
	for-upstream: yes
	for-downstream: no

auth-zone:
	name: "<signed-lab>.<base-domain>"
	zonefile: "<signed-lab>.<base-domain>.zone"
	fallback-enabled: no
	for-upstream: yes
	for-downstream: no

auth-zone:
	name: "<signed-lab6>.<base-domain>"
	zonefile: "<signed-lab6>.<base-domain>.zone"
	fallback-enabled: no
	for-upstream: yes
	for-downstream: no
cachedb:
	redis-server-host: 127.0.0.1
	redis-server-port: 6379
	redis-timeout: 1000
```

## zone signing
